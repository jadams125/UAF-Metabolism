---
title: "Q_2022_Epscor"
author: "Jacob Adams"
date: "1/10/2023"
output: html_document
---

The purpose of this script is to read in pressure transducer data from 2022 and generate rating curves to ultimately generate predicted continuous discharge records throughout the whole season.

Read in most updated merged files from each site from the google drive (DoD Project->2022 AK sensors->Discharge->site->"merged_date_file" )


```{r setup, include = FALSE}
# Load packages #
library(tidyverse)
library(lubridate)
library(data.table)
library(rio)
library(ggplot2)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(readr)
library(dplyr)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(birk)
library(imputeTS)
library(neonUtilities)
```



### ALL Sites ###

```{r, warning = FALSE, message = FALSE}
# Import data from google drive #
discharge.2022 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vShT-LAI5cw0hJmCnrIv-cxTsltXr1piGZsC4tKucqOdo3QMRx5vcD6dNXw6PjM-OBDOLt5_7g3-o4z/pub?output=csv"
QSummary.2022 <- read.csv(url(discharge.2022))

### Format Time ###
QSummary.2022$Date <- mdy(QSummary.2022$Date)
QSummary.2022$DateTimeAK <- as.POSIXct(paste(QSummary.2022$Date, QSummary.2022$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
QSummary.2022$DateTimeAK <- lubridate::round_date(QSummary.2022$DateTimeAK, "60 minutes")

### ALL Sites ###
QSummary.2022 %>% ggplot() +
  geom_point(aes(x=DateTimeAK, y=MeasuredQ_Ls, color=Site, shape=Method), size=3) +
  theme_classic() +
  scale_color_manual(values=c("#FF7F00","#A6761D", "#6A3D9A")) + ggtitle("ALL SITES") 



```
Import 2022 STRT and POKE Q to make a rating curve off of 

```{r}

QSummary.2022

Q_test <- QSummary.2022 %>%
  pivot_wider(names_from = Site, values_from = MeasuredQ_Ls)


DoD_Q <- read.csv("C:/Users/jacob/OneDrive - University of Alaska/GitHub/DoD_Discharge/Predicted_Discharge/2022/Predicted_Q_2022_gapfill.csv")

DoD_Q$DateTimeAK <- as.POSIXct(DoD_Q$DateTimeAK, tz = "America/Anchorage")


```


```{r}
# rating curve # 



DoD_Epscor_Q <- full_join(DoD_Q,Q_test, tz= "DateTimeAK")






DoD_Epscor_Q_test <- DoD_Epscor_Q %>% select(datetimeAK, DO.obs.CDS, DO.obs.CUS) %>%  pivot_longer(cols=c('DO.obs.CUS', 'DO.obs.CDS'),
                                                                                        names_to='Location',
                                                                                        values_to='DO.obs')


#CRAW
p1 <- DoD_Epscor_Q %>% ggplot(aes(x=CRAW, y= POKE.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()+ggtitle("Craw")
p2 <- DoD_Epscor_Q %>% ggplot(aes(x=CRAW, y= STRT.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q %>% ggplot(aes(x=CRAW, y= MOOS.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q %>% ggplot(aes(x=CRAW, y= FRCH)) + geom_point()+ stat_poly_line() + stat_poly_eq()

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)


library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
library(ggpubr)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)


grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
fig2019 <- arrangeGrob(rbind(panA, panB, panC, panD, size="max"))
ggsave(path = here("outputs"), file = "CrawQ_RC.pdf", fig2019, width = 12, height = 16, units = "in")

#SHOV
p1 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV, y= POKE.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()+ggtitle("Shov, No YSI points removed")
p2 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV, y= STRT.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV, y= MOOS.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV, y= FRCH)) + geom_point()+ stat_poly_line() + stat_poly_eq()


dev.next()

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)

library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)

grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
SHOVQ_RC <- arrangeGrob(panA, panB, panD, panD,size="max")
ggsave(path = here("outputs"), file = "SHOVQ_RC.pdf", SHOVQ_RC, width = 12, height = 16, units = "in")





#MAST
p1 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST, y= POKE.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq() +ggtitle("Mast, No YSI points removed")
p2 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST, y= STRT.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST, y= MOOS.Q.int)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST, y= FRCH)) + geom_point()+ stat_poly_line() + stat_poly_eq()

dev.next()

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)



library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)

grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
MASTQ_RC <- arrangeGrob(panA, panB, panD, panD,size="max")
ggsave(path = here("outputs"), file = "MASTQ_RC.pdf", MASTQ_RC, width = 12, height = 16, units = "in")


asd

 

DoD_Epscor_Q_remove <- DoD_Epscor_Q %>%
  mutate(across(c(MAST, depth),
                ~ifelse(as.character(datetimeAK) == "2019-07-08 13:00:00", NA, .)))





```


