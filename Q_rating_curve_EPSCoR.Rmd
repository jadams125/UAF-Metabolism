---
title: "Q_2022_Epscor"
author: "Jacob Adams"
date: "1/10/2023"
output: html_document
---

The purpose of this script is to read in pressure transducer data from 2022 and generate rating curves to ultimately generate predicted continuous discharge records throughout the whole season.

Read in most updated merged files from each site from the google drive (DoD Project->2022 AK sensors->Discharge->site->"merged_date_file" )


```{r setup, include = FALSE}
# Load packages #
library(tidyverse)
library(lubridate)
library(data.table)
library(rio)
library(ggplot2)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(readr)
library(dplyr)
library(dataRetrieval)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(birk)
library(imputeTS)
library(neonUtilities)
library(ggpubr)
library(neonUtilities)

```



### ALL Sites ###

```{r, warning = FALSE, message = FALSE}
# Import data from google drive #
discharge.2022 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vShT-LAI5cw0hJmCnrIv-cxTsltXr1piGZsC4tKucqOdo3QMRx5vcD6dNXw6PjM-OBDOLt5_7g3-o4z/pub?output=csv"
QSummary.2022 <- read.csv(url(discharge.2022))

### Format Time ###
QSummary.2022$Date <- mdy(QSummary.2022$Date)
QSummary.2022$DateTimeAK <- as.POSIXct(paste(QSummary.2022$Date, QSummary.2022$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
QSummary.2022$DateTimeAK <- lubridate::round_date(QSummary.2022$DateTimeAK, "60 minutes")

### ALL Sites ###
QSummary.2022 %>% ggplot() +
  geom_point(aes(x=DateTimeAK, y=MeasuredQ_Ls, color=Site, shape=Method), size=3) +
  theme_classic() +
  scale_color_manual(values=c("#FF7F00","#A6761D", "#6A3D9A")) + ggtitle("ALL SITES") 



```
Import 2022 STRT and POKE Q to make a rating curve off of 

```{r}

QSummary.2022

Q_test <- QSummary.2022 %>%
  pivot_wider(names_from = Site, values_from = MeasuredQ_Ls)


DoD_Q <- read.csv("C:/Users/jacob/OneDrive - University of Alaska/GitHub/DoD_Discharge/Predicted_Discharge/2022/Predicted_Q_2022_gapfill.csv")

DoD_Q$DateTimeAK <- as.POSIXct(DoD_Q$DateTimeAK, tz = "America/Anchorage")

DoD_Epscor_Q <- full_join(DoD_Q,Q_test, tz= "DateTimeAK")




# GoldstramQ

goldstream <- readNWISdata(
  site = c("15457790"), 
  tz = "America/Anchorage", 
  parameterCd = "00060",
  startDate = "2022-01-01",
  endDate = "2022-12-30",
  service = c("uv"))




 


goldstream$DateTimeAK <- as.POSIXct(goldstream$dateTime, tz = "America/Anchorage")

goldstream <- goldstream %>% select(DateTimeAK, X_00060_00000) %>% rename(goldstream = X_00060_00000)



DoD_Epscor_Q <- full_join(DoD_Epscor_Q,goldstream, tz= "DateTimeAK")

DoD_Epscor_Q <- DoD_Epscor_Q %>% fill(goldstream, .direction = "down")

chena <- readNWISdata(
  site = c("15493000"), 
  tz = "America/Anchorage", 
  parameterCd = "00060",
  startDate = "2022-01-01",
  endDate = "2022-12-30",
  service = c("uv"))

chena$DateTimeAK <- as.POSIXct(chena$dateTime, tz = "America/Anchorage")

chena <- chena %>% select(DateTimeAK, X_00060_00000) %>% rename(chena = X_00060_00000)



DoD_Epscor_Q <- full_join(DoD_Epscor_Q,chena, tz= "DateTimeAK")

# DoD_Epscor_Q <- DoD_Epscor_Q %>% fill(chena, .direction = "down")







readTableNEON()


CariQ <- loadByProduct(dpID="DP4.00130.001", 
                           site=c("CARI"),
                           startdate="2021-05", 
                           enddate="2022-11")


CariQ <- loadByProduct(dpID = "DP4.00130.001",
                        startdate = "2022-01",
                        enddate = "2022-11",
                        site = c("CARI"),
                        package = "basic")

list2env(CariQ, .GlobalEnv)

CariQ.dat <- CariQ$csd_continuousDischarge



## Q 
CariQ.dat2 <- CariQ.dat %>% select(c("endDate", "maxpostDischarge", "dischargeFinalQF", "dischargeFinalQFSciRvw"))

# 
# 
# setDT(DoD_Epscor_Q)
# setDT(goldstream)
# 
# DoD_Epscor_Q$DateTimeAK1 <- DoD_Epscor_Q$DateTimeAK
# 
# setkey( DoD_Epscor_Q, DateTimeAK )
# setkey( DoD_Epscor_Q, DateTimeAK )
# 
# shov <- DoD_Epscor_Q %>% select(DateTimeAK, SHOV)
# 
# goldstreamfill <-goldstream %>%  fill(goldstream, .direction = "down")
# 
# 
# setkey( goldstreamfill, DateTimeAK )
# setkey( shov, DateTimeAK )
# 
# 
# #WR was taken when EXO out of water. round depth point to nearest in data record
# testtable <- goldstreamfill[shov, roll = "nearest" ]
# testtable2 <- goldstream[shov, roll = "nearest" ]






```


```{r}
# rating curve # 









DoD_Epscor_Q_test <- DoD_Epscor_Q %>% select(datetimeAK, DO.obs.CDS, DO.obs.CUS) %>%  pivot_longer(cols=c('DO.obs.CUS', 'DO.obs.CDS'),
                                                                                        names_to='Location',
                                                                                        values_to='DO.obs')


#CRAW


DoD_Epscor_Q_remove_craw <- DoD_Epscor_Q %>%
  mutate(across(c(CRAW),
                ~ifelse(as.character(X) == "3429", NA, .)))

p1 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= POKE)) + geom_point()+ stat_poly_line() + stat_poly_eq()+ggtitle("Craw, One WR removed")
p2 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= STRT)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= MOOS)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= FRCH )) + geom_point()+ stat_poly_line() + stat_poly_eq()
p5 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= goldstream)) + geom_point()+ stat_poly_line() + stat_poly_eq()+scale_y_continuous(limit = c(-10, 50))
p6 <- DoD_Epscor_Q_remove_craw %>% ggplot(aes(x=CRAW,y= chena)) + geom_point()+ stat_poly_line() + stat_poly_eq()


dev.next()

ggarrange(p1,p2,p3,p4,p5,p6, ncol = 3, nrow = 2)



library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
library(ggpubr)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)


grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
fig2019 <- arrangeGrob(rbind(panA, panB, panC, panD, size="max"))
ggsave(path = here("outputs"), file = "CrawQ_RC.pdf", fig2019, width = 12, height = 16, units = "in")

#SHOV
p1 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV,y= POKE, color = Method, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()+ggtitle("Shov, No YSI points removed")
p2 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV,y= STRT, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV,y= MOOS, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q %>% ggplot(aes(x=SHOV,y= FRCH , color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()


dev.next()

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)

library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)

grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
SHOVQ_RC <- arrangeGrob(panA, panB, panD, panD,size="max")
ggsave(path = here("outputs"), file = "SHOVQ_RC.pdf", SHOVQ_RC, width = 12, height = 16, units = "in")





#MAST
p1 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST,y= POKE, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq() +ggtitle("Mast, No YSI points removed")
p2 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST,y= STRT, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST,y= MOOS, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q %>% ggplot(aes(x=MAST,y= FRCH , color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()

dev.next()

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)



library(grid)
library(ggeffects)
library(gridExtra)
library(gtable)
# If that doesnt do it, add grid
# Make each of the plots

# Two-panel figure: effect sizes
panA <- ggplotGrob(p1)
panB <- ggplotGrob(p2)
panC <- ggplotGrob(p3)
panD <- ggplotGrob(p4)

grid::grid.newpage()
grid.draw(rbind(panA, panB, panC, panD,size="max"))
MASTQ_RC <- arrangeGrob(panA, panB, panD, panD,size="max")
ggsave(path = here("outputs"), file = "MASTQ_RC.pdf", MASTQ_RC, width = 12, height = 16, units = "in")


asd

 



#MAST Remove

DoD_Epscor_Q_remove_mast <- DoD_Epscor_Q %>%
  mutate(across(c(MAST),
                ~ifelse(as.character(X) == "6205", NA, .)))

p1 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= POKE)) + geom_point()+ stat_poly_line() + stat_poly_eq() +ggtitle("Mast, One YSI point removed")
p2 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= STRT)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= MOOS)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= FRCH)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p5 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= goldstream)) + geom_point()+ stat_poly_line() + stat_poly_eq() + stat_poly_eq()+scale_y_continuous(limit = c(-10, 50))
p6 <- DoD_Epscor_Q_remove_mast %>% ggplot(aes(x=MAST,y= chena)) + geom_point()+ stat_poly_line() + stat_poly_eq()


dev.next()

ggarrange(p1,p2,p3,p4,p5,p6, ncol = 2, nrow = 3)



#Shov Remove

# DoD_Epscor_Q_remove_shov <- DoD_Epscor_Q %>%
# mutate(across(c(SHOV),
#               ~ifelse(as.character(X) == "6481", NA, .)))



DoD_Epscor_Q_remove_shov <- DoD_Epscor_Q %>%
  mutate(across(c(SHOV),
                ~ifelse(as.character(X) == "3517", NA, .)))

p1 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= POKE)) + geom_point()+ stat_poly_line() + stat_poly_eq() +ggtitle("SHOV, one YSI point removed")
p2 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= STRT)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= MOOS)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= FRCH )) + geom_point()+ stat_poly_line() + stat_poly_eq()
p5 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= goldstream)) + geom_point()+ stat_poly_line() + stat_poly_eq() + stat_poly_eq()+scale_y_continuous(limit = c(-20, 100))
p6 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= chena)) + geom_point()+ stat_poly_line() + stat_poly_eq()+scale_y_continuous(limit = c(-10, 2000))


dev.next()

ggarrange(p1,p2,p3,p4,p5,p6, ncol = 3, nrow = 2)



p1 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= POKE, color = Method, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()+ggtitle("Shov, No YSI points removed")
p2 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= STRT, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p3 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= MOOS, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
p4 <- DoD_Epscor_Q_remove_shov %>% ggplot(aes(x=SHOV,y= FRCH , color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()

dev.next()

ggarrange(p1,p2,p3,p4,p5, ncol = 3, nrow = 2)


# #CRAW Remove
# 
# DoD_Epscor_Q_remove_CRAW <- DoD_Epscor_Q %>%
#   mutate(across(c(CRAW),
#                 ~ifelse(as.character(X) == "3429", NA, .)))
# 
# p1 <- DoD_Epscor_Q_remove_CRAW %>% ggplot(aes(x=CRAW,y= POKE, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq() +ggtitle("CRAW, One Wading Rod point removed")
# p2 <- DoD_Epscor_Q_remove_CRAW %>% ggplot(aes(x=CRAW,y= STRT, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
# p3 <- DoD_Epscor_Q_remove_CRAW %>% ggplot(aes(x=CRAW,y= MOOS, color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
# p4 <- DoD_Epscor_Q_remove_CRAW %>% ggplot(aes(x=CRAW,y= FRCH , color = Method)) + geom_point()+ stat_poly_line() + stat_poly_eq()
# 
# dev.next()
# 
# ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2)


```


